<!DOCTYPE html>
<html>

<head>
  <title>VMware Cloud Knowledge</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Unofficial documentation for VMware Cloud">
  <meta name="generator" content="Hugo 0.63.2" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://dspinhirne.github.io/vmcbook/main.css">
  <script type="text/javascript" src="https://dspinhirne.github.io/vmcbook/main.js"></script>
</head>

  <body>
    
    <header class="main-header">
      <div>
        <a href="https://cloud.vmware.com"><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/resources/images/vm.svg"></a>
      </div>
      <div><a href="https://dspinhirne.github.io/vmcbook/">VMware Cloud Knowledge</a></div>
      <div>
        <a href="https://github.com/dspinhirne/vmcbook" class="github-link"><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/resources/images/github.svg"><span>Star</span></a>
      </div>
    </header>

    <article class="main-article">
      <nav class="left-nav">
        <ul class="top-level"><li >
        <span title="Getting Started" onclick="leftNavClick(this)">Getting Started</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/getting-started/" >Index</a></li>
        <li ><a title="Introduction" href="/vmcbook/guides/getting-started/introduction/" >Introduction</a></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/getting-started/howto/" >Index</a></li>
        <li ><a title="Activate Services" href="/vmcbook/guides/getting-started/howto/activate-services/" >Activate Services</a></li><li ><a title="Billing" href="/vmcbook/guides/getting-started/howto/billing/" >Billing</a></li><li ><a title="Manage Users" href="/vmcbook/guides/getting-started/howto/manage-users/" >Manage Users</a></li>
      </ul></li>
      </ul></li><li >
        <span title="HCX" onclick="leftNavClick(this)">HCX</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/hcx/" >Index</a></li>
        <li >
        <span title="A Technical Overview" onclick="leftNavClick(this)">A Technical Overview</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/hcx/a-technical-overview/" >Index</a></li>
        <li ><a title="Introduction" href="/vmcbook/guides/hcx/a-technical-overview/introduction/" >Introduction</a></li><li ><a title="Planning" href="/vmcbook/guides/hcx/a-technical-overview/planning/" >Planning</a></li><li ><a title="Preparation" href="/vmcbook/guides/hcx/a-technical-overview/preparation/" >Preparation</a></li><li ><a title="Testing" href="/vmcbook/guides/hcx/a-technical-overview/testing/" >Testing</a></li><li ><a title="Migration" href="/vmcbook/guides/hcx/a-technical-overview/migration/" >Migration</a></li>
      </ul></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/hcx/howto/" >Index</a></li>
        <li ><a title="Activate" href="/vmcbook/guides/hcx/howto/activate/" >Activate</a></li><li ><a title="Install" href="/vmcbook/guides/hcx/howto/install/" >Install</a></li><li ><a title="Network Extension" href="/vmcbook/guides/hcx/howto/network-extension/" >Network Extension</a></li><li ><a title="Workload Migration" href="/vmcbook/guides/hcx/howto/workload-migration/" >Workload Migration</a></li>
      </ul></li>
      </ul></li><li class="open parent">
        <span title="VMware Cloud on AWS" onclick="leftNavClick(this)">VMware Cloud on AWS</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/" >Index</a></li>
        <li ><a title="A Technical Overview" href="/vmcbook/guides/vmc-aws/a-technical-overview/" >A Technical Overview</a></li><li >
        <span title="On-Boarding" onclick="leftNavClick(this)">On-Boarding</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/on-boarding/" >Index</a></li>
        <li ><a title="Introduction" href="/vmcbook/guides/vmc-aws/on-boarding/introduction/" >Introduction</a></li><li ><a title="Requirements" href="/vmcbook/guides/vmc-aws/on-boarding/requirements/" >Requirements</a></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/on-boarding/howto/" >Index</a></li>
        <li ><a title="Term Subscription" href="/vmcbook/guides/vmc-aws/on-boarding/howto/term-subscription/" >Term Subscription</a></li><li ><a title="SDDC" href="/vmcbook/guides/vmc-aws/on-boarding/howto/sddc/" >SDDC</a></li>
      </ul></li>
      </ul></li><li class="open parent">
        <span title="Compute" onclick="leftNavClick(this)">Compute</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/compute/" >Index</a></li>
        <li ><a title="vCenter Architecture" href="/vmcbook/guides/vmc-aws/compute/vcenter-architecture/" >vCenter Architecture</a></li><li class="open parent"><a title="Stretched Clusters" href="/vmcbook/guides/vmc-aws/compute/stretched-cluster/" class="active">Stretched Clusters</a></li><li ><a title="EDRS" href="/vmcbook/guides/vmc-aws/compute/edrs/" >EDRS</a></li>
      </ul></li><li >
        <span title="Storage" onclick="leftNavClick(this)">Storage</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/storage/" >Index</a></li>
        <li ><a title="vSAN Architecture" href="/vmcbook/guides/vmc-aws/storage/vsan-architecture/" >vSAN Architecture</a></li>
      </ul></li><li >
        <span title="Networking" onclick="leftNavClick(this)">Networking</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/" >Index</a></li>
        <li ><a title="SDDC Network Architecture" href="/vmcbook/guides/vmc-aws/networking/sddc-network-architecture/" >SDDC Network Architecture</a></li><li ><a title="DNS and DHCP" href="/vmcbook/guides/vmc-aws/networking/dns-and-dhcp/" >DNS and DHCP</a></li><li >
        <span title="IPSec VPN" onclick="leftNavClick(this)">IPSec VPN</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/" >Index</a></li>
        <li ><a title="Concepts" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/concepts/" >Concepts</a></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/howto/" >Index</a></li>
        <li ><a title="Configure" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/howto/configure/" >Configure</a></li><li ><a title="Troubleshoot" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/howto/troubleshoot/" >Troubleshoot</a></li><li ><a title="Sample Configs" href="/vmcbook/guides/vmc-aws/networking/ipsec-vpn/howto/sample-configs/" >Sample Configs</a></li>
      </ul></li>
      </ul></li><li >
        <span title="Direct Connect" onclick="leftNavClick(this)">Direct Connect</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/direct-connect/" >Index</a></li>
        <li ><a title="Concepts" href="/vmcbook/guides/vmc-aws/networking/direct-connect/concepts/" >Concepts</a></li><li >
        <span title="Index" onclick="leftNavClick(this)">Index</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/direct-connect/howto/" >Index</a></li>
        <li ><a title="Configure" href="/vmcbook/guides/vmc-aws/networking/direct-connect/howto/configure/" >Configure</a></li>
      </ul></li>
      </ul></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/networking/howto/" >Index</a></li>
        <li ><a title="Network Segments" href="/vmcbook/guides/vmc-aws/networking/howto/network-segments/" >Network Segments</a></li>
      </ul></li>
      </ul></li><li >
        <span title="Network Security" onclick="leftNavClick(this)">Network Security</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/network-security/" >Index</a></li>
        <li ><a title="Concepts" href="/vmcbook/guides/vmc-aws/network-security/concepts/" >Concepts</a></li><li >
        <span title="HowTo" onclick="leftNavClick(this)">HowTo</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/network-security/howto/" >Index</a></li>
        <li ><a title="Services" href="/vmcbook/guides/vmc-aws/network-security/howto/services/" >Services</a></li><li ><a title="Groups" href="/vmcbook/guides/vmc-aws/network-security/howto/groups/" >Groups</a></li><li ><a title="Gateway Firewall" href="/vmcbook/guides/vmc-aws/network-security/howto/gateway-firewall/" >Gateway Firewall</a></li><li ><a title="DFW" href="/vmcbook/guides/vmc-aws/network-security/howto/dfw/" >DFW</a></li><li ><a title="NAT" href="/vmcbook/guides/vmc-aws/network-security/howto/nat/" >NAT</a></li>
      </ul></li>
      </ul></li><li >
        <span title="Validated Designs" onclick="leftNavClick(this)">Validated Designs</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/validated-designs/" >Index</a></li>
        <li >
        <span title="Network" onclick="leftNavClick(this)">Network</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/validated-designs/network/" >Index</a></li>
        <li ><a title="Hub-and-Spoke Designs" href="/vmcbook/guides/vmc-aws/validated-designs/network/hub-and-spoke-designs/" >Hub-and-Spoke Designs</a></li><li ><a title="Transit Gateway" href="/vmcbook/guides/vmc-aws/validated-designs/network/transit-gateway/" >Transit Gateway</a></li>
      </ul></li>
      </ul></li><li >
        <span title="Appendix" onclick="leftNavClick(this)">Appendix</span><ul>
        <li><a  title="Index" href="/vmcbook/guides/vmc-aws/appendix/" >Index</a></li>
        <li ><a title="Instance Types" href="/vmcbook/guides/vmc-aws/appendix/instance-types/" >Instance Types</a></li><li ><a title="Management Footprint" href="/vmcbook/guides/vmc-aws/appendix/management-footprint/" >Management Footprint</a></li>
      </ul></li>
      </ul></li><li >
        <span title="Site" onclick="leftNavClick(this)">Site</span><ul>
        <li><a  title="Index" href="/vmcbook/site/" >Index</a></li>
        <li ><a title="Authoring Guide" href="/vmcbook/site/authoring-guide/" >Authoring Guide</a></li><li ><a title="Information" href="/vmcbook/site/information/" >Information</a></li><li ><a title="Links" href="/vmcbook/site/links/" >Links</a></li><li ><a title="Resources" href="/vmcbook/site/resources/" >Resources</a></li><li ><a title="Color Scheme" href="/vmcbook/site/color-scheme/" >Color Scheme</a></li>
      </ul></li></ul>
      </nav>

      <main class="main-content">  <div class="TableOfContents">
    <h1>Page Contents</h1>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a>
      <ul>
        <li><a href="#what-are-availability-zones">What are Availability Zones?</a></li>
        <li><a href="#what-is-a-stretched-cluster-sddc">What is a Stretched-Cluster SDDC?</a></li>
        <li><a href="#why-deploy-a-stretched-cluster-sddc">Why Deploy A Stretched-Cluster SDDC?</a></li>
      </ul>
    </li>
    <li><a href="#architecture">Architecture</a>
      <ul>
        <li><a href="#implementation-overview">Implementation Overview</a></li>
        <li><a href="#enabling-dual-site-mirroring">Enabling Dual Site Mirroring</a></li>
        <li><a href="#resource-reservation">Resource Reservation</a></li>
        <li><a href="#az-affinity">AZ Affinity</a></li>
        <li><a href="#workload-balancing">Workload Balancing</a></li>
        <li><a href="#data-reads-and-writes">Data Reads and Writes</a></li>
      </ul>
    </li>
    <li><a href="#additional-considerations">Additional Considerations</a>
      <ul>
        <li><a href="#adding-and-removing-hosts">Adding and Removing Hosts</a></li>
        <li><a href="#maximum-cluster-size">Maximum Cluster Size</a></li>
        <li><a href="#minimum-host-counts">Minimum Host Counts</a></li>
        <li><a href="#network-architecture">Network Architecture</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>

  
  <article class="content with-toc">
    <header class="content-header">
      <h1>VMware Cloud on AWS</h1><h2>Compute:&nbspStretched Clusters</h2></header>

    <h2 id="overview">Overview</h2>
<h3 id="what-are-availability-zones">What are Availability Zones?</h3>
<p>AWS Regions are designed around the notion of fault domains, or <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">Availability Zones</a> (AZ). Within a Region, an AZ serves a couple of notable purposes:</p>
<ol>
<li>It acts as a boundary for resource management. In other words, the compute (and other) resources available to an AZ are finite and may become exhausted by customer demands. AWS will remove an AZ from the list of available AZs should it become resource constrained.</li>
<li>It is built to be independently resilient, meaning failures in one AZ should not impact any other AZ.</li>
</ol>

<figure><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/guides/vmc-aws/compute/stretched-cluster/az.png" alt="Availability Zones" />
    <figcaption>Availability Zones</figcaption></figure>

<p>The network infrastructure of an AWS Region is designed in such a way to support connectivity between Availability Zones. However, while network traffic within an AZ is not billable, network traffic which crosses between AZs will be <a href="https://aws.amazon.com/govcloud-us/pricing/data-transfer/">billed</a>. Data transfer charges and inter-AZ network performance are important considerations when designing a multi-AZ deployment within AWS.</p>
<h3 id="what-is-a-stretched-cluster-sddc">What is a Stretched-Cluster SDDC?</h3>
<p>A standard (non-stretched) SDDC is one in which all hosts are deployed within a single AZ. On the other hand, a stretched-cluster SDDC is one in which the hosts of the SDDC are evenly split between 2 AZs within an AWS Region (with a hidden &ldquo;witness&rdquo; host in a 3rd AZ).</p>

<figure><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/guides/vmc-aws/compute/stretched-cluster/stretched-cluster-sddc.png" alt="A Stretched-Cluster SDDC" />
    <figcaption>A Stretched-Cluster SDDC</figcaption></figure>

<p>The choice of a stretched-cluster vs a standard SDDC is a decision which must be made at the time of SDDC deployment. Once it has been deployed, it is not possible to convert a standard SDDC to a stretched-cluster SDDC (or vice-versa). Furthermore, all Clusters of the SDDC will be uniformly implemented as stretched or non-stretched.</p>
<h3 id="why-deploy-a-stretched-cluster-sddc">Why Deploy A Stretched-Cluster SDDC?</h3>
<p>Simply put, stretched-cluster SDDCs offer an availability strategy to customers. They are designed specifically to provide the SDDC with an extra layer of resiliency in the event of host-level failures within the cluster or with AZ-level failures within the region.</p>
<p>It is important to keep in mind that stretched-cluster SDDCs only offer an  additional layer of resiliency and do not address all failure scenarios. For instance, they do not protect against regional-level failures within AWS or data loss scenarios resulting from application issues or poorly planned storage policies. These types of scenarios fall outside of the scope of the protection offered by a stretched-cluster SDDC and must be addressed by a detailed data recovery strategy.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="implementation-overview">Implementation Overview</h3>
<p>Stretched-cluster SDDCs are implemented using a vSAN <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vsan-planning.doc/GUID-1BDC7194-67A7-4E7C-BF3A-3A0A32AEECA9.html">feature</a> of the same name. Per the requirements of vSAN, the SDDC provides 2 data sites and one witness host per cluster. The data sites are composed of 2 groups of hosts, which are evenly split between a pair of AZs. The witness host is implemented behind the scenes, using a custom <a href="https://aws.amazon.com/ec2/">EC2</a> instance, and is deployed to a 3rd AZ which is separate from that of the data sites. This witness host is not reflected within the total host count of the SDDC.</p>
<p>Due to the requirement that stretched-cluster SDDCS utilize a total of 3 AZs, they are only supported in AWS Regions which are able to provide at least 3 AZs.</p>
<p>When deploying a stretched-cluster SDDC, AZ mapping for the data sites is controlled by the end user through the selection of cross-link Subnets for the SDDC. The details of this portion of the design are covered in the <a href="https://dspinhirne.github.io/vmcbook/guides/vmc-aws/networking/sddc-network-architecture/">SDDC Network Architecture</a> guide.</p>
<h3 id="enabling-dual-site-mirroring">Enabling Dual Site Mirroring</h3>
<p>A stretched-cluster SDDC offers additional resiliency for workloads; however, this feature is end-user controllable and is implemented through the vSAN policies applied to workloads. By choosing the &ldquo;Dual Site Mirroring (stretched cluster)&rdquo; for the &ldquo;Site disaster tolerance&rdquo; option of a vSAN storage policy, data for VMs which use the policy will have their data synchronized between the fault domains of the SDDC.</p>

<figure><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/guides/vmc-aws/compute/stretched-cluster/vsan-policy.png" alt="A Dual Site Mirroring Policy" />
    <figcaption>A Dual Site Mirroring Policy</figcaption></figure>

<p>The storage policy for the management appliances is automatically configured to implement dual site mirroring and cannot be changed.</p>
<p>As a side note, the fault domains of vSAN are mapped to the Availability Zones of the SDDC and are visible from the vSAN portion of the Cluster configuration within vCenter. Additionally, the fault domains of individual hosts and VMs are visible from their summary pages.</p>
<h3 id="resource-reservation">Resource Reservation</h3>
<p>Since the function of a stretched-cluster SDDC is to provide additional resiliency to workloads, the SDDC must ensure that appropriate resources are reserved within each AZ to facilitate a cross-AZ migration. This is an important consideration when performing capacity planning for a stretched-cluster SDDC.</p>
<p>Note that you must also include the management appliances as part of your capacity planning process, as they are configured for dual site mirroring by default.</p>
<h3 id="az-affinity">AZ Affinity</h3>
<p>AZ affinity refers to the AZ in which a VM prefers to run. This &ldquo;preference&rdquo; by the VM is based solely on the AZ in which it was most recently booted. For instance, if the SDDC is deployed within Availability Zones AZ-1a and AZ-1b, and a VM is deployed to a host within AZ-1a, then that VM is considered to prefer AZ-1a as its &ldquo;home&rdquo; AZ. This means that the VM will tend to stay within that AZ (i.e., DRS will keep it within that AZ) unless a failure occurs which triggers a recovery into the other AZ.</p>

<figure><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/guides/vmc-aws/compute/stretched-cluster/az-affinity.png" alt="Workload AZ Affinity" />
    <figcaption>Workload AZ Affinity</figcaption></figure>

<p>vSphere HA will always attempt to keep a VM within its home AZ. Should the AZ suffer a host failure, vSphere HA will:</p>
<ol>
<li>Attempt to recover the VM on another host within the same AZ. Should there be insufficient resources to recover the VM, then it will..</li>
<li>Attempt to recover the VM on a host within the other AZ.</li>
</ol>
<p>A VM which is recovered in a different AZ will now consider that AZ as its &ldquo;home&rdquo;.</p>
<h3 id="workload-balancing">Workload Balancing</h3>
<p>There is no mechanism today to automatically balance workload placement between AZs. This process must be managed by the customer.</p>
<h3 id="data-reads-and-writes">Data Reads and Writes</h3>
<p>It is important to understand the read/write behavior of workloads which utilize a Dual Site Mirroring enabled vSAN policy. For reads, the data is read from the local copy (i.e., the &ldquo;home&rdquo; AZ of the workload). For writes, the data is written locally as well as synchronously replicated to the hosts of the twin AZ. These synchronous writes will result in cross-AZ network traffic, the amount of which is highly dependent on the I/O profile of the workloads.</p>

<figure><img src="https://media.githubusercontent.com/media/dspinhirne/vmcbook/master/guides/vmc-aws/compute/stretched-cluster/data-io.png" alt="Local Read, Synchronous Write" />
    <figcaption>Local Read, Synchronous Write</figcaption></figure>

<h2 id="additional-considerations">Additional Considerations</h2>
<h3 id="adding-and-removing-hosts">Adding and Removing Hosts</h3>
<p>One notable difference between a standard SDDC and a stretched-cluster SDDC is the way hosts are added and removed from the SDDC. Since hosts of a stretched-cluster SDDC must be equally balanced between AZs, add/remove operations will be done in pairs. In other words, you may only increment or decrement the hosts of a Cluster two at a time.</p>
<h3 id="maximum-cluster-size">Maximum Cluster Size</h3>
<p>A common misconception is that, since a stretched-cluster SDDC is managing host groups which are split across AZs, that it offers twice the total host count per Cluster. In reality, the maximum host per Cluster for a stretched-cluster SDDC is identical to that of a standard SDDC; the hosts just happen to be split across two AZs.</p>
<p>The witness host of the Cluster does not count toward the maximum.</p>
<h3 id="minimum-host-counts">Minimum Host Counts</h3>
<p>Since a stretched-cluster SDDC must be able to survive a total failure of a single AZ, each host group (the hosts of a Cluster which are within a common AZ) is required to contain a minimum number of hosts to constitute a production SDDC. This means that the minimum number of hosts for a stretched-cluster SDDC is <em>twice</em> that of a standard SDDC.</p>
<p>The witness host of the Cluster does not count toward the minimum.</p>
<h3 id="network-architecture">Network Architecture</h3>
<p>The network architecture for stretched-cluster SDDCs is slightly different than that of a standard SDDC. Due to the fact that hosts of the SDDC are split between AZs, cross-AZ bandwidth charges will be accrued as part of the normal day-to-day operation of the SDDC. The details of this are covered in the <a href="/vmcbook/guides/vmc-aws/networking/sddc-network-architecture/">SDDC Network Architecture</a> guide.</p>
    
    <footer class="content-footer"><div>
          Written by <a href="/vmcbook/author/dspinhirne/">Dustin Spinhirne</a>
          </div><div>
          Originally published Friday, Feb 7, 2020.
          </div></footer>

  </article></main>
    </article>
    
  </body>
</html>
